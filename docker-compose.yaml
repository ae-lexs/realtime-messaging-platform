# Infrastructure services for development and testing.
# Use with: docker compose up -d
# Or with dev overlay: docker compose -f docker-compose.yaml -f docker-compose.dev.yaml up

services:
  # LocalStack - AWS services emulator (DynamoDB, Secrets Manager, SSM, SNS)
  localstack:
    image: localstack/localstack:3.4
    ports:
      - "4566:4566"      # LocalStack Gateway
      - "4510-4559:4510-4559"  # External service ports
    environment:
      - SERVICES=dynamodb,secretsmanager,ssm,sns
      - DEBUG=0
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redpanda - Kafka-compatible streaming platform
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --smp 1
      - --memory 1G
      - --mode dev-container
      - --default-log-level=warn
    ports:
      - "18081:18081"  # Schema Registry
      - "18082:18082"  # Pandaproxy (REST)
      - "19092:19092"  # Kafka external
      - "19644:9644"   # Admin API
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redpanda Console - Kafka UI
  redpanda-console:
    image: redpandadata/console:v2.5.2
    ports:
      - "8888:8080"
    environment:
      - KAFKA_BROKERS=redpanda:9092
    depends_on:
      redpanda:
        condition: service_healthy

  # Redis - Connection routing, caching, rate limiting
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  localstack-data:
  redpanda-data:
  redis-data:

networks:
  default:
    name: messaging-network
