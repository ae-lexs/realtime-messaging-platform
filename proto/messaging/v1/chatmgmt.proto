syntax = "proto3";

package messaging.v1;

import "google/api/annotations.proto";
import "messaging/v1/common.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option go_package = "github.com/aelexs/realtime-messaging-platform/gen/messaging/v1;messagingv1";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "Realtime Messaging Platform API";
    version: "1.0.0";
    description: "REST API for the Realtime Messaging Platform. Covers authentication (OTP login, token lifecycle, sessions) and chat management (chat CRUD, membership, message history).";
  };
  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";
  security_definitions: {
    security: {
      key: "Bearer";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
        description: "JWT access token. Format: Bearer <token>";
      };
    };
  };
};

// AuthService handles authentication operations on the Chat Mgmt service.
// OTP-based passwordless login, token lifecycle, and session management.
// Exposes both gRPC and REST (via grpc-gateway) endpoints (ADR-015).
service AuthService {
  // RequestOTP sends a one-time password to the given phone number.
  rpc RequestOTP(RequestOTPRequest) returns (RequestOTPResponse) {
    option (google.api.http) = {
      post: "/v1/auth/otp/request"
      body: "*"
    };
  }

  // VerifyOTP verifies an OTP and returns authentication tokens.
  // Creates a new user if the phone number is not registered.
  rpc VerifyOTP(VerifyOTPRequest) returns (VerifyOTPResponse) {
    option (google.api.http) = {
      post: "/v1/auth/otp/verify"
      body: "*"
    };
  }

  // RefreshTokens exchanges a refresh token for new access and refresh tokens.
  // Requires the (potentially expired) access token in the Authorization header.
  rpc RefreshTokens(RefreshTokensRequest) returns (RefreshTokensResponse) {
    option (google.api.http) = {
      post: "/v1/auth/tokens/refresh"
      body: "*"
    };
  }

  // Logout revokes the current session.
  // Requires a valid access token in the Authorization header.
  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post: "/v1/auth/logout"
      body: "*"
    };
  }
}

// ChatMgmtService handles chat lifecycle and membership operations.
// Exposes both gRPC and REST (via grpc-gateway) endpoints.
service ChatMgmtService {
  // CreateChat creates a new chat (direct or group).
  // For direct chats, returns existing chat if one already exists for the pair.
  rpc CreateChat(CreateChatRequest) returns (CreateChatResponse) {
    option (google.api.http) = {
      post: "/v1/chats"
      body: "*"
    };
  }

  // GetChat retrieves chat details by ID.
  rpc GetChat(GetChatRequest) returns (GetChatResponse) {
    option (google.api.http) = {
      get: "/v1/chats/{chat_id}"
    };
  }

  // ListChats lists chats the user is a member of.
  rpc ListChats(ListChatsRequest) returns (ListChatsResponse) {
    option (google.api.http) = {
      get: "/v1/chats"
    };
  }

  // AddMember adds a user to a group chat.
  // Direct chats do not allow membership changes.
  rpc AddMember(AddMemberRequest) returns (AddMemberResponse) {
    option (google.api.http) = {
      post: "/v1/chats/{chat_id}/members"
      body: "*"
    };
  }

  // RemoveMember removes a user from a group chat.
  // Only chat owner can remove members.
  rpc RemoveMember(RemoveMemberRequest) returns (RemoveMemberResponse) {
    option (google.api.http) = {
      delete: "/v1/chats/{chat_id}/members/{user_id}"
    };
  }

  // LeaveChat removes the calling user from a group chat.
  // Owner cannot leave (must transfer ownership first).
  rpc LeaveChat(LeaveChatRequest) returns (LeaveChatResponse) {
    option (google.api.http) = {
      post: "/v1/chats/{chat_id}/leave"
      body: "*"
    };
  }

  // GetMessages retrieves message history for a chat.
  rpc GetMessages(GetMessagesRequest) returns (GetMessagesResponse) {
    option (google.api.http) = {
      get: "/v1/chats/{chat_id}/messages"
    };
  }
}

// CreateChatRequest contains parameters for creating a chat.
message CreateChatRequest {
  // Type of chat to create.
  ChatType chat_type = 1;

  // Display name for group chats. Ignored for direct chats.
  string name = 2;

  // Initial members. For direct chats, must contain exactly 2 user IDs.
  // For group chats, must contain at least 2 and at most 100 user IDs.
  repeated string member_ids = 3;
}

// CreateChatResponse contains the created or existing chat.
message CreateChatResponse {
  // The chat.
  Chat chat = 1;

  // True if this is an existing direct chat (idempotent creation).
  bool is_existing = 2;
}

// GetChatRequest identifies the chat to retrieve.
message GetChatRequest {
  string chat_id = 1;
}

// GetChatResponse contains the requested chat.
message GetChatResponse {
  Chat chat = 1;
}

// ListChatsRequest contains pagination parameters.
message ListChatsRequest {
  // Pagination.
  PageRequest page = 1;
}

// ListChatsResponse contains the user's chats.
message ListChatsResponse {
  // Chats the user is a member of.
  repeated Chat chats = 1;

  // Pagination metadata.
  PageResponse page = 2;
}

// AddMemberRequest specifies the member to add.
message AddMemberRequest {
  string chat_id = 1;
  string user_id = 2;
}

// AddMemberResponse confirms the member was added.
message AddMemberResponse {
  // Updated member count.
  int32 member_count = 1;
}

// RemoveMemberRequest specifies the member to remove.
message RemoveMemberRequest {
  string chat_id = 1;
  string user_id = 2;
}

// RemoveMemberResponse confirms the member was removed.
message RemoveMemberResponse {
  // Updated member count.
  int32 member_count = 1;
}

// LeaveChatRequest identifies the chat to leave.
message LeaveChatRequest {
  string chat_id = 1;
}

// LeaveChatResponse confirms the user left.
message LeaveChatResponse {}

// GetMessagesRequest specifies message history query parameters.
message GetMessagesRequest {
  string chat_id = 1;

  // Return messages with sequence > after_sequence.
  // Used for sync-on-reconnect.
  optional uint64 after_sequence = 2;

  // Return messages with sequence < before_sequence.
  // Used for backward pagination.
  optional uint64 before_sequence = 3;

  // Pagination.
  PageRequest page = 4;
}

// GetMessagesResponse contains message history.
message GetMessagesResponse {
  // Messages in ascending sequence order.
  repeated Message messages = 1;

  // Pagination metadata.
  PageResponse page = 2;
}

// Chat represents a chat room.
message Chat {
  string chat_id = 1;
  ChatType chat_type = 2;
  string name = 3;

  // Number of members.
  int32 member_count = 4;

  // When the chat was created.
  Timestamp created_at = 5;

  // Last message sequence (for sync purposes).
  uint64 last_sequence = 6;
}

// ChatMember represents a chat membership.
message ChatMember {
  string user_id = 1;
  string chat_id = 2;

  // Role in the chat.
  MemberRole role = 3;

  // When the user joined.
  Timestamp joined_at = 4;
}

// MemberRole defines user roles in a chat.
enum MemberRole {
  MEMBER_ROLE_UNSPECIFIED = 0;
  MEMBER_ROLE_MEMBER = 1;
  MEMBER_ROLE_OWNER = 2;
}

// ChatCreatedEvent is published to Kafka when a chat is created.
// Topic: chats.created
message ChatCreatedEvent {
  Chat chat = 1;
  repeated ChatMember initial_members = 2;
  Timestamp event_time = 3;
}

// MembershipChangedEvent is published to Kafka when membership changes.
// Topic: memberships.changed
message MembershipChangedEvent {
  string chat_id = 1;
  string user_id = 2;
  MembershipChangeType change_type = 3;
  Timestamp event_time = 4;
}

// MembershipChangeType defines types of membership changes.
enum MembershipChangeType {
  MEMBERSHIP_CHANGE_TYPE_UNSPECIFIED = 0;
  MEMBERSHIP_CHANGE_TYPE_JOINED = 1;
  MEMBERSHIP_CHANGE_TYPE_LEFT = 2;
  MEMBERSHIP_CHANGE_TYPE_REMOVED = 3;
}

// ============================================================================
// Auth messages (ADR-015)
// ============================================================================

// RequestOTPRequest contains the phone number to send an OTP to.
message RequestOTPRequest {
  // Phone number in E.164 format (e.g., "+14155552671").
  string phone_number = 1;
}

// RequestOTPResponse confirms the OTP was sent.
message RequestOTPResponse {
  // When the OTP expires.
  Timestamp expires_at = 1;

  // Seconds before the client may request a new OTP.
  int32 retry_after_seconds = 2;
}

// VerifyOTPRequest contains the OTP and device information.
message VerifyOTPRequest {
  // Phone number in E.164 format.
  string phone_number = 1;

  // The 6-digit OTP code.
  string otp = 2;

  // Client-generated device identifier (UUIDv4).
  string device_id = 3;
}

// VerifyOTPResponse contains the authenticated user and tokens.
message VerifyOTPResponse {
  // The authenticated user.
  AuthUser user = 1;

  // Session identifier.
  string session_id = 2;

  // JWT access token.
  string access_token = 3;

  // Opaque refresh token.
  string refresh_token = 4;

  // True if this is a newly registered user.
  bool is_new_user = 5;

  // When the access token expires.
  Timestamp access_token_expires_at = 6;
}

// RefreshTokensRequest contains the refresh token to exchange.
message RefreshTokensRequest {
  // The current refresh token.
  string refresh_token = 1;
}

// RefreshTokensResponse contains the new tokens.
message RefreshTokensResponse {
  // New JWT access token.
  string access_token = 1;

  // New opaque refresh token.
  string refresh_token = 2;

  // When the new access token expires.
  Timestamp access_token_expires_at = 3;
}

// LogoutRequest contains the refresh token to revoke.
message LogoutRequest {
  // The current refresh token (ensures client holds both tokens).
  string refresh_token = 1;
}

// LogoutResponse is empty on success.
message LogoutResponse {}

// AuthUser represents an authenticated user returned by auth endpoints.
message AuthUser {
  // Unique user identifier.
  string user_id = 1;

  // Phone number in E.164 format.
  string phone_number = 2;

  // User display name (empty for new users).
  string display_name = 3;

  // Whether the phone number is verified.
  bool phone_verified = 4;

  // When the user was created.
  Timestamp created_at = 5;
}
